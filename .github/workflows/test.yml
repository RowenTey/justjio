name: Run Unit Tests

on:
  pull_request:
    types: [labeled]
    branches:
      - main
      - dev
  workflow_dispatch:

jobs:
  test-api-server:
    runs-on: ubuntu-latest
    if: ${{ github.event.label.name == 'ready_for_tests' || github.event_name == 'workflow_dispatch' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: 1.23
          cache: true
          cache-dependency-path: server-api/go.sum

      - name: Install dependencies
        run: cd server-api && go mod download

      - name: Run unit tests
        id: test-step
        run: cd server-api && go test -v ./...

  remove-ready-for-tests-label:
    if: always() && ${{ github.event.label.name == 'ready_for_tests' }}
    needs: [test-api-server]
    runs-on: ubuntu-latest
    steps:
      - name: Remove `ready_for_tests` label
        uses: actions-ecosystem/action-remove-labels@v1
        with:
          github_token: ${{ secrets.PAT }}
          labels: ready_for_tests

  add-ready-for-scan-label:
    if: success() && ${{ github.event.label.name == 'ready_for_tests' }}
    needs: [test-api-server]
    runs-on: ubuntu-latest
    steps:
      - name: Add `ready_for_scan` label
        uses: actions-ecosystem/action-add-labels@v1
        with:
          github_token: ${{ secrets.PAT }}
          labels: ready_for_scan
